<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>林㕦新字</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #fafafa;
            color: #333;
            font-family: 'Noto Serif', serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .subtitle {
            font-family: "Nom Na Tong", "HanaMinA", "SimSun", serif;
            font-size: 2.5rem;
            font-weight: normal;
            color: #222;
            margin: 0;
            margin-bottom: 10px;
        }

        .stats {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-top: 5px;
        }

        .stats span {
            margin: 0 8px;
        }

        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px 16px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Noto Serif', serif;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #666;
        }

        button {
            padding: 10px 20px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            font-family: "Nom Na Tong", "HanaMinA", "SimSun", serif;
            font-size: 1.3rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #555;
        }

        .tabs {
            display: none;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tab-btn {
            padding: 8px 24px;
            background: white;
            color: #666;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: "Nom Na Tong", "HanaMinA", "SimSun", serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: #999;
            color: #333;
        }

        .tab-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        .filter-box {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .filter-box label {
            font-size: 14px;
            color: #666;
        }

        .filter-box select {
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Noto Serif', serif;
            font-size: 14px;
            cursor: pointer;
        }

        .filter-box select:focus {
            outline: none;
            border-color: #666;
        }

        .results-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .welcome-text {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        .card {
            background: white;
            border: 2px solid #eee;
            border-radius: 6px;
            padding: 20px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: #ddd;
        }

        .card.multi-char {
            flex-direction: column;
            gap: 12px;
        }

        .nom-char {
            font-family: "Nom Na Tong", "HanaMinA", "SimSun", serif;
            font-size: 3.5rem;
            color: #222;
            min-width: 80px;
            text-align: center;
        }

        .nom-char.multi {
            font-size: 2rem;
            letter-spacing: 0.2em;
            text-align: left;
        }

        .nom-info {
            flex: 1;
        }

        .nom-info p {
            margin-bottom: 6px;
        }

        .label {
            color: #999;
            font-size: 13px;
            margin-right: 6px;
        }

        .am-text {
            color: #666;
            font-weight: normal;
            font-size: 1.2rem;
        }

        .zhengyin-text {
            color: #000;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .giai-text {
            color: #666;
            font-size: 14px;
        }

        .note-text {
            color: #999;
            font-size: 13px;
        }

        .compound-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .compound-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .compound-item {
            background: #f5f5f5;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .compound-item .compound-char {
            font-family: "Nom Na Tong", "HanaMinA", "SimSun", serif;
            color: #222;
            margin-right: 4px;
        }

        .compound-item .compound-reading {
            color: #666;
            font-size: 13px;
        }

        @media (max-width: 600px) {
            .subtitle {
                font-size: 2rem;
            }
            
            .card {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .nom-char {
                min-width: auto;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h2 class="subtitle">林㕦新字</h2>
            <div class="stats" id="stats"></div>
        </header>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="字 | dăngc | * (全部)" autocomplete="off">
            <button onclick="performSearch()">𬑑</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('single')">字</button>
            <button class="tab-btn" onclick="switchTab('multi')">詞</button>
        </div>

        <div class="filter-box">
            <label for="levelFilter">常用度:</label>
            <select id="levelFilter" onchange="performSearch()">
                <option value="all">全部</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>

        <div id="resultArea" class="results-grid">
            <div class="welcome-text"><p>Đang tải dữ liệu...</p></div>
        </div>
    </div>

    <script>
        var dataSingle = [];
        var dataCompound = [];
        var currentTab = 'single';
        var sheetCounts = { han: 0, gu: 0, jin: 0 };

        async function loadData() {
            try {
                var response = await fetch('qmuen.xlsx');
                var buffer = await response.arrayBuffer();
                var workbook = XLSX.read(buffer, { type: 'array' });
                
                var hanSheet = workbook.Sheets['漢'];
                var guSheet = workbook.Sheets['古'];
                var jinSheet = workbook.Sheets['今'];
                var ciSheet = workbook.Sheets['詞'];
                
                var hanData = XLSX.utils.sheet_to_json(hanSheet, { header: 1 });
                var guData = XLSX.utils.sheet_to_json(guSheet, { header: 1 });
                var jinData = XLSX.utils.sheet_to_json(jinSheet, { header: 1 });
                var ciData = ciSheet ? XLSX.utils.sheet_to_json(ciSheet, { header: 1 }) : [];
                
                for (var i = 1; i < hanData.length; i++) {
                    var row = hanData[i];
                    if (row[1]) {
                        dataSingle.push({
                            char: String(row[1]).trim(),
                            level: row[0] || 1,
                            reading: row[2] ? String(row[2]).trim() : '',
                            altReading: row[3] ? String(row[3]).trim() : '',
                            meaning: '',
                            note: ''
                        });
                        sheetCounts.han++;
                    }
                }
                
                for (var i = 1; i < guData.length; i++) {
                    var row = guData[i];
                    if (row[1]) {
                        dataSingle.push({
                            char: String(row[1]).trim(),
                            level: row[0] || 1,
                            reading: row[2] ? String(row[2]).trim() : '',
                            altReading: '',
                            meaning: row[3] ? String(row[3]).trim() : '',
                            note: ''
                        });
                        sheetCounts.gu++;
                    }
                }
                
                for (var i = 1; i < jinData.length; i++) {
                    var row = jinData[i];
                    if (row[1]) {
                        dataSingle.push({
                            char: String(row[1]).trim(),
                            level: row[0] || 1,
                            reading: row[2] ? String(row[2]).trim() : '',
                            altReading: '',
                            meaning: row[3] ? String(row[3]).trim() : '',
                            note: ''
                        });
                        sheetCounts.jin++;
                    }
                }
                
                for (var i = 1; i < ciData.length; i++) {
                    var row = ciData[i];
                    if (row[1]) {
                        dataCompound.push({
                            char: String(row[1]).trim(),
                            level: row[0] || 1,
                            reading: row[2] ? String(row[2]).trim() : '',
                            altReading: '',
                            meaning: '',
                            note: ''
                        });
                    }
                }
                
                document.getElementById('resultArea').innerHTML = '';
                
                var total = dataSingle.length;
                var hanPercent = ((sheetCounts.han / total) * 100).toFixed(1);
                var guPercent = ((sheetCounts.gu / total) * 100).toFixed(1);
                var jinPercent = ((sheetCounts.jin / total) * 100).toFixed(1);
                
                document.getElementById('stats').innerHTML = 
                    '<span>漢: ' + sheetCounts.han + ' (' + hanPercent + '%)</span>' +
                    '<span>俗: ' + sheetCounts.gu + ' (' + guPercent + '%)</span>' +
                    '<span>造: ' + sheetCounts.jin + ' (' + jinPercent + '%)</span>' +
                    '<span>總: ' + total + '</span>';
                
                console.log('Đã tải:', dataSingle.length, 'từ đơn |', dataCompound.length, 'từ ghép');
                
            } catch (error) {
                console.error('Lỗi tải file:', error);
                document.getElementById('resultArea').innerHTML = 
                    '<div class="welcome-text"><p>Không thể tải file qmuen.xlsx</p></div>';
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            var buttons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            event.target.classList.add('active');
            
            performSearch();
        }

        function matchWildcard(text, pattern) {
            if (!text || !pattern) return false;
            
            var escaped = pattern.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
            var regexPattern = escaped.replace(/\*/g, '.*');
            var regex = new RegExp('^' + regexPattern + '[rhdxsclbz]?$', 'i');
            
            return regex.test(text);
        }

        function matchReading(text, query) {
            if (!text || !query) return false;
            
            if (query.indexOf('*') !== -1) {
                return matchWildcard(text, query);
            }
            
            var lowerText = text.toLowerCase();
            var lowerQuery = query.toLowerCase();
            
            if (lowerText === lowerQuery) return true;
            
            var toneMarks = ['r', 'h', 'd', 'x', 's', 'c', 'l', 'b', 'z'];
            for (var i = 0; i < toneMarks.length; i++) {
                if (lowerText === lowerQuery + toneMarks[i]) {
                    return true;
                }
            }
            
            return false;
        }

        function performSearch() {
            var query = document.getElementById('searchInput').value.trim();
            var level = document.getElementById('levelFilter').value;
            var resultArea = document.getElementById('resultArea');
            var tabsContainer = document.querySelector('.tabs');
            var filterBox = document.querySelector('.filter-box');
            
            resultArea.innerHTML = '';

            if (query === '') {
                tabsContainer.style.display = 'none';
                filterBox.style.display = 'none';
                return;
            }

            var singleResults = [];
            var multiResults = [];

            if (query === '*') {
                singleResults = dataSingle.slice();
                multiResults = dataCompound.slice();
            } else {
                var hasWildcard = query.indexOf('*') !== -1;
                
                for (var i = 0; i < dataSingle.length; i++) {
                    var item = dataSingle[i];
                    var found = false;
                    
                    if (item.reading) {
                        if (item.reading.indexOf(',') !== -1) {
                            var readings = item.reading.split(',');
                            for (var j = 0; j < readings.length; j++) {
                                if (matchReading(readings[j].trim(), query)) {
                                    found = true;
                                    break;
                                }
                            }
                        } else {
                            if (matchReading(item.reading, query)) {
                                found = true;
                            }
                        }
                    }
                    
                    if (!found && item.altReading) {
                        if (item.altReading.indexOf(',') !== -1) {
                            var altReadings = item.altReading.split(',');
                            for (var j = 0; j < altReadings.length; j++) {
                                if (matchReading(altReadings[j].trim(), query)) {
                                    found = true;
                                    break;
                                }
                            }
                        } else {
                            if (matchReading(item.altReading, query)) {
                                found = true;
                            }
                        }
                    }
                    
                    if (!found && !hasWildcard && item.char && item.char === query) {
                        found = true;
                    }
                    
                    if (found) {
                        singleResults.push(item);
                    }
                }
                
                for (var i = 0; i < dataCompound.length; i++) {
                    var item = dataCompound[i];
                    var found = false;
                    
                    if (item.reading) {
                        if (item.reading.indexOf(',') !== -1) {
                            var readings = item.reading.split(',');
                            for (var j = 0; j < readings.length; j++) {
                                if (matchReading(readings[j].trim(), query)) {
                                    found = true;
                                    break;
                                }
                            }
                        } else {
                            if (matchReading(item.reading, query)) {
                                found = true;
                            }
                        }
                    }
                    
                    if (!found && !hasWildcard && item.char && item.char === query) {
                        found = true;
                    }
                    
                    if (found) {
                        multiResults.push(item);
                    }
                }
            }

            if (level !== 'all') {
                var filteredSingle = [];
                for (var i = 0; i < singleResults.length; i++) {
                    if (singleResults[i].level == level) {
                        filteredSingle.push(singleResults[i]);
                    }
                }
                singleResults = filteredSingle;
                
                var filteredMulti = [];
                for (var i = 0; i < multiResults.length; i++) {
                    if (multiResults[i].level == level) {
                        filteredMulti.push(multiResults[i]);
                    }
                }
                multiResults = filteredMulti;
            }

            if (singleResults.length === 0 && multiResults.length === 0) {
                tabsContainer.style.display = 'none';
                filterBox.style.display = 'none';
                resultArea.innerHTML = '<div class="welcome-text"><p>Không tìm thấy kết quả.</p></div>';
                return;
            }

            filterBox.style.display = 'flex';

            var singleTab = document.querySelector('.tab-btn[onclick*="single"]');
            var multiTab = document.querySelector('.tab-btn[onclick*="multi"]');
            
            if (singleResults.length > 0 && multiResults.length > 0) {
                tabsContainer.style.display = 'flex';
                singleTab.style.display = 'block';
                multiTab.style.display = 'block';
            } else if (singleResults.length > 0) {
                tabsContainer.style.display = 'flex';
                singleTab.style.display = 'block';
                multiTab.style.display = 'none';
                currentTab = 'single';
                singleTab.classList.add('active');
            } else {
                tabsContainer.style.display = 'flex';
                singleTab.style.display = 'none';
                multiTab.style.display = 'block';
                currentTab = 'multi';
                multiTab.classList.add('active');
            }

            var results = currentTab === 'single' ? singleResults : multiResults;
            
            for (var idx = 0; idx < results.length; idx++) {
                var item = results[idx];
                var card = document.createElement('div');
                var isMulti = item.char.length > 1;
                
                card.className = isMulti ? 'card multi-char' : 'card';
                
                var charClass = isMulti ? 'nom-char multi' : 'nom-char';
                
                var allReadings = [];
                
                if (item.reading) {
                    var readings = item.reading.split(',');
                    for (var i = 0; i < readings.length; i++) {
                        var r = readings[i].trim();
                        if (r) {
                            allReadings.push({ text: r, isMain: false });
                        }
                    }
                }
                
                if (item.altReading) {
                    var altReadings = item.altReading.split(',');
                    for (var i = 0; i < altReadings.length; i++) {
                        var r = altReadings[i].trim();
                        if (r) {
                            allReadings.push({ text: r, isMain: true });
                        }
                    }
                }
                
                var uniqueReadings = [];
                var seen = {};
                
                for (var i = 0; i < allReadings.length; i++) {
                    var r = allReadings[i];
                    var key = r.text.toLowerCase();
                    
                    if (!seen[key]) {
                        seen[key] = true;
                        uniqueReadings.push(r);
                    } else if (r.isMain) {
                        for (var j = 0; j < uniqueReadings.length; j++) {
                            if (uniqueReadings[j].text.toLowerCase() === key && !uniqueReadings[j].isMain) {
                                uniqueReadings[j] = r;
                                break;
                            }
                        }
                    }
                }
                
                var readingDisplay = '';
                if (uniqueReadings.length > 0) {
                    var parts = [];
                    for (var i = 0; i < uniqueReadings.length; i++) {
                        var r = uniqueReadings[i];
                        var className = r.isMain ? 'zhengyin-text' : 'am-text';
                        parts.push('<span class="' + className + '">' + r.text + '</span>');
                    }
                    readingDisplay = parts.join(', ');
                } else {
                    readingDisplay = '<span class="am-text">' + item.reading + '</span>';
                }
                
                var compoundHTML = '';
                if (currentTab === 'single' && !isMulti) {
                    var related = [];
                    for (var i = 0; i < dataCompound.length; i++) {
                        if (dataCompound[i].char.indexOf(item.char) !== -1) {
                            related.push(dataCompound[i]);
                        }
                    }
                    
                    if (related.length > 0) {
                        var items = [];
                        for (var i = 0; i < related.length; i++) {
                            var comp = related[i];
                            items.push('<span class="compound-item"><span class="compound-char">' + 
                                      comp.char + '</span><span class="compound-reading">' + 
                                      comp.reading + '</span></span>');
                        }
                        
                        compoundHTML = '<div class="compound-section"><p><span class="label">詞:</span></p>' +
                                      '<div class="compound-list">' + items.join('') + '</div></div>';
                    }
                }
                
                var meaningHTML = '';
                if (item.meaning) {
                    meaningHTML = '<p><span class="label">解字:</span> <span class="giai-text">' + 
                                 item.meaning + '</span></p>';
                }
                
                var noteHTML = '';
                if (item.note) {
                    noteHTML = '<p><span class="label">註:</span> <span class="note-text">' + 
                              item.note + '</span></p>';
                }
                
                card.innerHTML = '<div class="' + charClass + '">' + item.char + '</div>' +
                                '<div class="nom-info"><p>' + readingDisplay + '</p>' +
                                meaningHTML + noteHTML + compoundHTML + '</div>';
                
                resultArea.appendChild(card);
            }
        }

        document.getElementById("searchInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                performSearch();
            }
        });

        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>